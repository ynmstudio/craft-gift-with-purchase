{% extends "_layouts/cp" %}

{% set title = 'Gift Rules'|t('gift-with-purchase') %}
{% set selectedSubnavItem = 'rules' %}

{% do view.registerAssetBundle('craft\\web\\assets\\admintable\\AdminTableAsset') %}
{% do view.registerTranslations('gift-with-purchase', [
    'Name',
    'Gift Price',
    'Duration',
    'Auto-add',
    'Enabled',
    'Disabled',
    'Set status',
    'Delete',
    'No gift rules exist yet.',
    'Gift rules reordered.',
    'Couldn\'t reorder gift rules.',
]) %}

{% block actionButton %}
    <a href="{{ url('gift-with-purchase/rules/new') }}" class="btn submit add icon">{{ 'New gift rule'|t('gift-with-purchase') }}</a>
{% endblock %}

{% block content %}
    <div id="gift-rules-vue-admin-table"></div>
{% endblock %}

{% set tableData = [] %}
{% for rule in giftRules %}
    {% set dateRange = (rule.dateFrom ? rule.dateFrom|datetime('short') : '∞') ~ ' - ' ~ (rule.dateTo ? rule.dateTo|datetime('short') : '∞') %}
    {% if not rule.dateFrom and not rule.dateTo %}
        {% set dateRange = '∞' %}
    {% endif %}

    {% set conditions = [] %}
    {% if rule.minSubtotal %}
        {% set conditions = conditions|merge(['Min: ' ~ rule.minSubtotal|currency]) %}
    {% endif %}
    {% if rule.maxSubtotal %}
        {% set conditions = conditions|merge(['Max: ' ~ rule.maxSubtotal|currency]) %}
    {% endif %}
    {% if not rule.allPurchasables %}
        {% set conditions = conditions|merge(['Specific products']) %}
    {% endif %}
    {% if not rule.allCategories %}
        {% set conditions = conditions|merge(['Specific categories']) %}
    {% endif %}

    {% set tableData = tableData|merge([{
        id: rule.id,
        title: rule.note ?: rule.name,
        url: url('gift-with-purchase/rules/' ~ rule.id),
        status: rule.enabled ? true : false,
        giftPrice: rule.giftPrice|currency,
        conditions: conditions|join(', ') ?: '—',
        duration: dateRange,
        autoAdd: rule.autoAdd ? true : false,
    }]) %}
{% endfor %}

{% js %}
    var actions = [
        {
            label: Craft.t('gift-with-purchase', 'Set status'),
            actions: [
                {
                    label: Craft.t('gift-with-purchase', 'Enabled'),
                    action: 'gift-with-purchase/gift-rules/update-status',
                    param: 'status',
                    value: 'enabled',
                    status: 'enabled'
                },
                {
                    label: Craft.t('gift-with-purchase', 'Disabled'),
                    action: 'gift-with-purchase/gift-rules/update-status',
                    param: 'status',
                    value: 'disabled',
                    status: 'disabled'
                }
            ]
        },
        {
            label: Craft.t('gift-with-purchase', 'Delete'),
            action: 'gift-with-purchase/gift-rules/delete',
            error: true,
        }
    ];

    var columns = [
        { name: '__slot:title', title: Craft.t('gift-with-purchase', 'Name') },
        { name: 'giftPrice', title: Craft.t('gift-with-purchase', 'Gift Price') },
        { name: 'conditions', title: Craft.t('gift-with-purchase', 'Conditions') },
        { name: 'duration', title: Craft.t('gift-with-purchase', 'Duration') },
        { name: 'autoAdd', title: Craft.t('gift-with-purchase', 'Auto-add'),
            callback: function(value) {
                if (value) {
                    return '<span data-icon="check" title="Yes"></span>';
                }
                return '';
            }
        },
    ];

    new Craft.VueAdminTable({
        actions: actions,
        checkboxes: true,
        columns: columns,
        container: '#gift-rules-vue-admin-table',
        deleteAction: 'gift-with-purchase/gift-rules/delete',
        emptyMessage: Craft.t('gift-with-purchase', 'No gift rules exist yet.'),
        padded: true,
        reorderAction: 'gift-with-purchase/gift-rules/reorder',
        reorderSuccessMessage: Craft.t('gift-with-purchase', 'Gift rules reordered.'),
        reorderFailMessage: Craft.t('gift-with-purchase', 'Couldn\'t reorder gift rules.'),
        tableData: {{ tableData|json_encode|raw }}
    });
{% endjs %}
